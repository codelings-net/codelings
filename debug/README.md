## How to run WebAssembly in the browser debugger

Stepping through the random WebAssembly programs generated by this project is a 
good way of gaining a better understanding of what they are doing.

The best tool right now (March 2021) is Chrome because it shows the WebAssembly 
value stack and, if you have access to version 89+, also has a Memory 
Inspector.

If you follow the instructions in this file, you should be able achieve 
something close to what's shown in the following screenshots:

Chrome:

![Chrome](chrome-screenshot.png)

Firefox:

![Firefox](firefox-screenshot.png)


### 1. Symlink the `wasm` file you'd like examine to `debug/debug.wasm`

If you have a `wasm` file you want to debug:

```bash
cd debug
mv debug.wasm debug.wasm.bak
ln -s path/to/you/file.wasm debug.wasm
```

If you do not have a `wasm` file that you would like to examine, you can skip 
this step and use the sample `debug.wasm` provided.

### 2. Start the HTTP server

```bash
cd debug
./http_server.py
```

### 3. Start the debugger

Go to the following URL:

http://localhost:4096/debug.html

Open developer tools:

- In the desktop version of Chrome, the shortcut is **Ctrl+Shift+I** or Menu 
(three vertical dots in the top right corner) > More Tools > Developer tools.

- In the desktop version of Firefox, the shortcut is **Ctrl+Shift+Z** or Menu 
(three horizontal dashes in the top right corner) > Web developer > Debugger.

Hard-reload the page (left-click on the Reload button while holding `Shift`).

Find the `wasm` file among the sources (left pane) and click on it. You should 
now see some WebAssembly code.

Toggle a breakpoint on one of the lines by clicking on the hex address on the 
left.

Hard-reload the page.

The debugger should now be paused on the breakpoint and you can step through 
the program by repeatedly pressing F11. You should be able to see the current 
values of the 16 local variables (most of them zero in the sample file). In 
Chrome, you should also be able to see the WebAssembly value stack.


### 4. Add the watch expression

The watch expression dumps a few key regions of WebAssembly memory. (If you 
feel like customising the JavaScript code for `dump()`, it is in `debug.html`.)

The expressions to use are as follows:

```javascript
dump(memory0)  // Google Chrome
dump($m)       // Firefox
```


### 5. Launch the Memory Inspector

The following only works in Chrome (sadly there is no Firefox equivalent) and 
only in version 89+, which as of March 2021 was only available from the 
developer beta channel. (The beta channel is publicly accessible without the 
need for any sign-up.)

The first step is to enable WebAssembly debugging via:

DevConsole > Settings (cogged wheel, top right) > Experiments => (tick) 
WebAssembly Debugging: ...

and then right-click on:

DevConsole > Scope (in the right pane) > Module > memories > $m Memory(1)

and choose 'Inspect memory'.
